# entity_pipeline_workflow.yaml
# Sub-workflow: loop over batches and invoke a single Cloud Run Job per batch

main:
  params: [payload]
  steps:
    # [0] Initialize project and region
    - init_vars:
        assign:
          - projectId: "horse-predictor-v2"
          - region:    "europe-central2"

    # [1] Loop over batches (0 to payload.batches-1)
    - batchLoop:
        for:
          value: i
          range:
            - 0
            - ${payload.batches - 1}
          steps:
            # [1a] Build request URLs for Cloud Run job invocation
            - buildUrls:
                assign:
                  - runUrl: >-
                      ${
                        "https://run.googleapis.com/v1/projects/" + projectId +
                        "/locations/" + region + "/jobs/" + payload.serviceName + ":run"
                      }
                  - jobName: >-
                      ${
                        "projects/" + projectId +
                        "/locations/" + region + "/jobs/" + payload.serviceName
                      }

            # [1b] Invoke the Cloud Run job for batch 'i'
            - runBatchJob:
                call: googleapis.run.v1.namespaces.jobs.run
                args:
                  name: ${"namespaces/" + projectId + "/jobs/" + payload.serviceName}
                  location: ${region}
                  body: {}
                result: jobResponse

    # [2] Return total batches processed
    - return:
        return: ${payload.batches}
