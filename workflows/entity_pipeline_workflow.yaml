# entity_pipeline_workflow.yaml
# Sub-workflow: loop over batches and invoke a single Cloud Run Job per batch

main:
  params: [payload]
  steps:
    # Initialization of variables
    - init_vars:
        assign:
          - projectId: "horse-predictor-v2"
          - region:    "europe-central2"
          - batches:   ${int(payload.batches)}
          - batchSize: ${int(payload.batchSize)}
          - startId:   ${int(payload.startId)}
          - serviceName: ${payload.serviceName}

    # Log start
    - log_init:
        call: sys.log
        args:
          text: >-
            ${"ğŸ”§ Starting pipeline: service=" + serviceName
              + ", batches=" + string(batches)
              + ", batchSize=" + string(batchSize)
              + ", startId=" + string(startId)}
          severity: INFO

    # Batch loop
    - batchLoop:
        for:
          value: i
          range:
            - 0
            - ${batches - 1}
          steps:
            - log_iteration:
                call: sys.log
                args:
                  text: >-
                    ${"â¡ï¸ Batch " + string(i + 1) + "/" + string(batches)
                      + " (startId=" + string(startId + i * batchSize)
                      + ", batchSize=" + string(batchSize) + ")"}
                  severity: INFO

            - run_batch_job:
                call: googleapis.run.v1.namespaces.jobs.run
                args:
                  name: ${"namespaces/" + projectId + "/jobs/" + serviceName}
                  location: ${region}
                  body:
                    overrides:
                      containerOverrides:
                        - args:
                            - ${string(startId + i * batchSize)}
                            - ${string(batchSize)}
                result: jobResp

            - log_job_resp:
                call: sys.log
                args:
                  text: >-
                    ${"âœ… Job invoked: " + jobResp.metadata.name}
                  severity: INFO

    # Completion log
    - log_done:
        call: sys.log
        args:
          text: >-
            ${"ğŸ Completed " + string(batches) + " batches for " + serviceName}
          severity: INFO

    # Return number of batches processed
    - return:
        return: ${batches}
