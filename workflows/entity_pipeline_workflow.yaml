# entity_pipeline_workflow.yaml
# Sub-workflow: loop over batches and invoke a single Cloud Run Job per batch

main:
  params: [serviceName, startId, batchSize, batches]

  steps:
    # Loop over batches (0 to batches-1)
    - batchLoop:
        loop:
          for:
            value: i
            in:
              start: 0
              end: ${batches}
              step: 1
        do:
          steps:
            # Invoke the Cloud Run job for batch i
            - runBatchJob:
                call: http.post
                args:
                  url: ${"https://run.googleapis.com/v1/projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT") + "/locations/europe-central2/jobs/" + serviceName + ":run"}
                  auth:
                    type: OAuth2
                  body:
                    name: ${"projects/" + sys.get_env("GOOGLE_CLOUD_PROJECT") + "/locations/europe-central2/jobs/" + serviceName}
                    parameters:
                      args:
                        - ${startId + i * batchSize}
                        - ${batchSize}
                result: jobResponse

    # Return number of batches processed
    - return:
        return: ${batches}
