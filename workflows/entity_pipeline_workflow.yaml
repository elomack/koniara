# entity_pipeline_workflow.yaml
# Sub-workflow: loop over batches and invoke a single Cloud Run Job per batch

main:
  params: [serviceName, startId, batchSize, batches]
  steps:
    # Loop over batches using count-based loop
    - batchLoop:
        loop:
          count: ${batches}
        steps:
          # Build request URLs for Cloud Run job invocation
          - buildUrls:
              assign:
                - runUrl: >-
                    ${
                      "https://run.googleapis.com/v1/projects/"
                        + sys.get_env("GOOGLE_CLOUD_PROJECT")
                        + "/locations/europe-central2/jobs/" + serviceName + ":run"
                    }
                - jobName: >-
                    ${
                      "projects/"
                        + sys.get_env("GOOGLE_CLOUD_PROJECT")
                        + "/locations/europe-central2/jobs/" + serviceName
                    }

          # Invoke the Cloud Run job for batch index
          - runBatchJob:
              call: http.post
              args:
                url: ${runUrl}
                auth:
                  type: OAuth2
                body:
                  name: ${jobName}
                  parameters:
                    args:
                      - ${startId + (index * batchSize)}
                      - ${batchSize}
              result: jobResponse

    # Return number of batches processed
    - return:
        return: ${batches}